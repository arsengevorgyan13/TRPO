**Дата:** 29 ноября 2025 г.

**Статус:** Принято

**Контекст:**
Проектируемая система управления автопарком должна соответствовать строгим нефункциональным требованиям, включая высокую производительность при работе с большими объемами данных GPS в реальном времени, масштабируемость для поддержки растущего числа пользователей и транспортных средств, а также высокую надежность и доступность. Для достижения этих целей необходимо выбрать подходящие архитектурные паттерны, которые обеспечат устойчивость системы к нагрузкам и ее эффективное развитие

**Рассмотренные варианты:**

**Трехзвенная структура**
Классическое разделение на презентационный уровень (веб-интерфейс для диспетчеров и мобильное приложение для водителей), уровень бизнес-логики и уровень данных. Это создает основу для четкого разделения ответственности, позволяет независимо масштабировать каждый уровень и развивать UI, не затрагивая бизнес-логику

**Кеширование**
Сохранение часто запрашиваемых или редко меняющихся данных в оперативной памяти для снижения задержек и нагрузки на основные базы данных. В системе автопарка идеально подходит для кеширования справочников (модели автомобилей, водители), статичных данных маршрутов, а также для агрегированных данных в отчетах. Главный минус - риск использования устаревших данных (инвалидация кеша должна быть тщательно продумана) и потребление дополнительных ресурсов памяти

**Толстый клиент**
Перенос части логики на сторону клиентского приложения. Для мобильного приложения водителя это может означать офлайн-кэширование его расписания и маршрутов, предварительную валидацию вводимых данных (например, сообщений об инцидентах), что снижает количество запросов к серверу и улучшает отзывчивость при плохом соединении. Недостатком является усложнение разработки и тестирования клиентских приложений, а также их зависимость от вычислительных ресурсов устройства пользователя

**Деградация функциональности**
В периоды экстремально высокой нагрузки (например, при одновременном входе тысяч водителей в систему в начале смены) система может временно отключать второстепенные функции, такие как генерация сложных аналитических отчетов или детальная история маршрутов за длительный период, чтобы обеспечить доступность и скорость работы критически важных функций: мониторинга местоположения, просмотра актуальных задач и отправки сообщений об инцидентах. Минус — ухудшение пользовательского опыта для тех, кто пользуется отключенными функциями

**Вертикальное масштабирование**
Увеличение вычислительной мощности отдельных серверов. Это наиболее простой и быстрый способ повысить производительность ключевых узлов, например, базы данных, обрабатывающей поток GPS-координат, на начальных этапах роста системы. Однако, у этого подхода есть физический и финансовый потолок, а также он создает единую точку отказа

**Горизонтальное масштабирование**
Добавление множества однотипных серверов (нод) и распределение нагрузки между ними с помощью балансировщиков. Этот паттерн является фундаментальным для обеспечения роста системы в соответствии с требованиями SCA01-SCA04, позволяя обрабатывать запросы от десятков тысяч пользователей одновременно. Недостатки — необходимость в sophisticated-инфраструктуре (оркестраторы, service discovery) и в проектировании приложения как stateless, либо в реализации механизмов для работы с состоянием (stateful services)

**SOA**
Является логическим развитием функционального разделения, где каждый сервис полностью автономен, имеет свою базу данных и общается с другими через четко определенные API (REST, gRPC, сообщения). Это идеально ложится на принцип модульности (PRN02). Например, сервис ТО может работать независимо от сервиса мониторинга. Основные минусы — высочайшая операционная сложность, проблемы распределенных транзакций и необходимость зрелой DevOps-культуры

**Монолитное приложение**
Противоположность SOA — вся функциональность системы собрана в единую кодовую базу и развертывается как одно целое. На самых ранних стадиях проекта это может упростить разработку и отладку. Однако, для такой сложной и высоконагруженной системы, как управление автопарком, монолит быстро станет узким местом, делая невозможным независимое масштабирование компонентов и замедляя процесс внесения изменений

**Отложенные вычисления**
Выполнение ресурсоемких операций не в момент запроса, а в фоновом режиме, когда это наиболее удобно для системы. Идеально подходит для генерации сложных отчетов о работе автопарка за месяц (F07), расчета агрегированной статистики по пробегу и расходу топлива. Это позволяет не нагружать систему в пиковые часы и дает пользователю возможность получить уведомление, когда отчет будет готов. Минус — пользователь не получает результат мгновенно.

**Асинхронная обработка**
Использование очередей сообщений (например, RabbitMQ или Kafka) для выполнения задач без блокировки основного потока выполнения. Критически важно для обработки входящего потока GPS-данных от тысяч трекеров, для отправки массовых push-уведомлений водителям (F06) и для взаимодействия с медленными внешними системами (например, геокодеры для построения маршрутов). Повышает общую пропускную способность и отказоустойчивость, но усложняет логику приложения и отладку.

**Конвейер**
Разбиение сложного процесса на последовательные этапы. Например, обработка нового заказа на перевозку может быть разбита на этапы: валидация -> оптимизация маршрута -> назначение водителя -> уведомление. Каждый этап может выполняться отдельным, узкоспециализированным сервисом, что повышает общую эффективность и упрощает замену отдельных компонентов. Недостаток — сложность управления потоком данных и обработки ошибок на конкретном этапе.

**Репликация**
Создание и поддержание копий данных на нескольких серверах. Для системы автопарка репликация БД является must-have для обеспечения отказоустойчивости (DUR03) и распределения нагрузки на чтение. Запросы на чтение (просмотр истории маршрутов, отчетов) можно направлять на реплики, разгружая основной мастер-узел, на который идет интенсивная запись GPS-треков. Недостатки — задержка репликации (data lag) и повышенные затраты на инфраструктуру.

**Вертикальный шардинг**
Размещение таблиц, относящихся к разным доменам, на разных физических серверах или даже в СУБД разного типа. Например, данные GPS-треков с высокой частотой записи можно хранить в специализированной БД, оптимизированной для временных рядов, а справочники автомобилей и водителей — в реляционной SQL БД. Это позволяет выбрать оптимальное хранилище для каждой задачи, но усложняет выполнение запросов, требующих объединения данных из разных шардов

**Горизонтальный шардинг**
Разделение одной большой таблицы на множество меньших частей (шардов) на основе ключа шардирования. Это основной способ масштабирования уровня данных для обработки огромных объемов информации, генерируемой GPS-трекерами. Позволяет распределить нагрузку записи и чтения по множеству серверов. Главный минус — сложность выполнения запросов, которые требуют данных из нескольких шардов одновременно

**Виртуальные шарды**
Использование уровня абстракции между логическими шардами и физическими серверами. Это упрощает перераспределение данных при добавлении или удалении серверов в кластере, так как перемещаются только виртуальные шарды, а не пересчитываются все ключи. Для системы, которая должна расти годами (SCA01-SCA04), этот паттерн значительно облегчает операции масштабирования базы данных

**Центральный диспетчер**
Использование единого компонента для принятия решений о маршрутизации. В системе автопарка это, в первую очередь, балансировщики нагрузки, которые распределяют входящие HTTP-запросы между экземплярами бэкенд-сервисов. Также это может быть шард-менеджер, который определяет, на какой шард писать или читать данные. Плюс — централизованное управление. Минус — риск создания единой точки отказа, что нивелируется использованием нескольких диспетчеров в кластере

**Партиционирование**
Логическое разделение данных внутри одной таблицы, например, по диапазонам дат. Историю перемещений (F09) можно партиционировать по месяцам. Это значительно ускоряет выполнение запросов к недавним данным и упрощает управление данными (например, можно быстро "отсечь" и архивировать старые партиции). Не решает проблему масштабирования записи, в отличие от шардинга

**Денормализация**
Сознательное дублирование данных в разных таблицах для ускорения операций чтения. Например, в таблицу с текущими задачами водителя можно добавить имя водителя и госномер автомобиля, чтобы избежать JOIN'ов при отображении списка задач. Это резко повышает производительность отчетов и сложных выборок, но усложняет процесс обновления данных и требует строгого контроля за целостностью

**Введение избыточности**
Создание резервных копий данных, сервисов и серверов для повышения отказоустойчивости. Это прямое выполнение требований DUR01 (бэкапы) и AVA03 (работа при недоступности подсервисов). Недостаток — прямые финансовые затраты на избыточное оборудование и программное обеспечение

**Параллельное выполнение**
Разбиение одной большой задачи на подзадачи и их одновременное выполнение. В автопарке это можно применить для одновременного пересчета оптимальных маршрутов для большой группы автомобилей или для параллельной обработки пакета GPS-координат. Позволяет значительно сократить время вычислений, но требует осторожного проектирования для избежания состояний гонки и эффективного использования ресурсов

**Специализированные серверa**
Выделение отдельных серверных кластеров для специфических, ресурсоемких задач. Это дает максимальную производительность для каждой задачи, но делает инфраструктуру более сложной в поддержке

**Comet-сервер**
Паттерн для реализации push-уведомлений от сервера к клиенту в реальном времени без постоянных опросов. Критически важен для функции мониторинга в реальном времени (F04), чтобы моментально обновлять карту для диспетчера при движении автомобиля, а также для мгновенной доставки сообщений от диспетчера к водителю (F10). Обеспечивает наилучший пользовательский опыт, но создает постоянную нагрузку на сервер из-за большого количества одновременных соединений

**Решение:**

Для системы управления автопарком принимается к применению следующий набор архитектурных паттернов:
1.  **Трехзвенная структура**
2.  **SOA**
3.  **Горизонтальное масштабирование**
4.  **Кеширование**
5.  **Асинхронная обработка**
6.  **Репликация**
7.  **Горизонтальный шардинг + Виртуальные шарды**
8.  **Специализированные серверы**
9.  **Comet-сервер**
10. **Отложенные вычисления**
11. **Центральный диспетчер**
12. **Деградация функциональности**

**Обоснование:**

*   **Трехзвенная структура** задает базовую, понятную организацию системы, разделяя клиентские приложения, серверную логику и данные
*   **SOA** является ядром архитектуры, реализуя принцип PRN02. Выделение сервисов для GPS-мониторинга, маршрутизации, уведомлений и ТО позволяет независимо масштабировать наиболее нагруженные компоненты (например, сервис GPS) и развивать систему силами разных команд
*   **Горизонтальное масштабирование** — основной способ выполнения требований по росту пользователей (SCA01-SCA04). Все stateless-сервисы должны быть готовы к развертыванию в несколько экземпляров за балансировщиком нагрузки
*   **Кеширование** применяется на всех уровнях: кеш запросов к справочникам в Redis, кеш статических ресурсов на CDN, кеш агрегированных данных для отчетов. Это напрямую улучшает выполнение требований PER01 и PER02
*   **Асинхронная обработка** через очереди сообщений необходима для обработки лавинообразного потока GPS-меток (PER03) и для отправки массовых уведомлений (F06), чтобы не блокировать основной поток выполнения запросов
*   **Репликация** БД обеспечивает отказоустойчивость (AVA01, DUR03) и разгружает мастер-узел, направляя запросы на чтение (отчеты, история) на реплики
*   **Горизонтальный шардинг + Виртуальные шарды** — стратегическое решение для масштабирования хранения данных GPS-треков (F09, F04), объем которых будет расти быстрее всего. Виртуальные шарды упростят управление кластером БД при его расширении
*   **Специализированные серверы** повысят эффективность: Elasticsearch для поиска и логов, Redis для кеша и сессий (F07, PRN03)
*   **Comet-сервер** (реализованный через WebSockets) для реализации интерактивной карты мониторинга в реальном времени (F04) и чата (F10), обеспечивая мгновенное обновление данных у диспетчера
*   **Отложенные вычисления** будут использоваться для генерации сложных и объемных отчетов (F07), чтобы не нагружать оперативные базы данных в рабочее время
*   **Центральный диспетчер** (балансировщики нагрузки, API Gateway) является необходимым элементом для маршрутизации запросов в микросервисной среде и обеспечения единой точки входа
*   **Деградация функциональности** — это механизм безопасности, который позволит системе под высокой нагрузкой сохранять работоспособность ключевых функций (мониторинг, задачи), временно отключая генерацию отчетов или детальную аналитику

**Последствия:**

*   **Высокая операционная сложность:** Микросервисы, шардирование, множество специализированных технологий потребуют зрелой DevOps-культуры, мощного мониторинга (MON01-MON03) и автоматизации
*   **Накладные расходы на коммуникацию:** Все вызовы между сервисами (gRPC, HTTP) и обмен сообщениями добавляют задержку и потребляют сетевые ресурсы
*   **Сложность обеспечения согласованности данных:** В распределенной системе неизбежна eventual consistency, что необходимо учитывать в бизнес-логике
*   **Рост затрат на инфраструктуру:** Множество серверов, кластеры БД, облачные услуги приведут к значительным операционным расходам
*   **Сложность разработки и отладки:** Командам потребуются глубокие знания в распределенных системах, а отладка проблем, затрагивающих несколько сервисов, будет challenging