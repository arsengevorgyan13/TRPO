@startuml C4 Infrastructure Deployment Diagram - Система управления автопарком
left to right direction
!include lib/C4_Deployment.puml

title C4 Infrastructure Deployment Diagram - Система управления автопарком

Deployment_Node(public_internet, "Public Internet") {
    Container(dns, "DNS Service", "DNS", "Разрешение доменных имен")
    Container(spa_client, "WEB SPA", "React Native", "Единое SPA приложение для всех ролей")
    Container(external_gps, "GPS Trackers", "External Hardware", "GPS-данные от устройств слежения")
    Container(gibdd_api, "ГИБДД API", "External Government API", "Проверка VIN/водительских удостоверений")
}

Deployment_Node(k8s_cluster, "Kubernetes Cluster") {
    Deployment_Node(gateway_layer, "Gateway Layer", "Ingress + API Gateway") {
        Container(envoy_gateway, "Envoy Proxy", "API Gateway", "Маршрутизация, аутентификация, rate limiting, балансировка")
    }

    Deployment_Node(worker_node_1, "Worker Node 1") {
        Container(auth_service_pod1, "Authentication Service", "Go", "replica 1/3")
        Container(centrifugo_pod1, "Centrifugo", "Go", "replica 1/3")
        Container(account_service_pod1, "Account Service", "Go", "replica 1/3")
        Container(user_service_pod1, "User Service", "Go", "replica 1/3")
        Container(car_service_pod1, "Car Service", "Go", "replica 1/3")
        Container(routing_service_pod1, "Routing Service", "Go", "replica 1/3")
        Container(scheduling_service_pod1, "Scheduling Service", "Go", "replica 1/3")
        Container(notifications_service_pod1, "Notifications Service", "Go", "replica 1/3")
        Container(maintenance_service_pod1, "Maintenance Service", "Go", "replica 1/3")
        Container(reports_service_pod1, "Reports Service", "Go", "replica 1/3")
    }

    Deployment_Node(worker_node_2, "Worker Node 2") {
        Container(auth_service_pod2, "Authentication Service", "Go", "replica 2/3")
        Container(centrifugo_pod2, "Centrifugo", "Go", "replica 2/3")
        Container(account_service_pod2, "Account Service", "Go", "replica 2/3")
        Container(user_service_pod2, "User Service", "Go", "replica 2/3")
        Container(car_service_pod2, "Car Service", "Go", "replica 2/3")
        Container(routing_service_pod2, "Routing Service", "Go", "replica 2/3")
        Container(scheduling_service_pod2, "Scheduling Service", "Go", "replica 2/3")
        Container(notifications_service_pod2, "Notifications Service", "Go", "replica 2/3")
        Container(maintenance_service_pod2, "Maintenance Service", "Go", "replica 2/3")
        Container(reports_service_pod2, "Reports Service", "Go", "replica 2/3")
    }

    Deployment_Node(worker_node_3, "Worker Node 3") {
        Container(auth_service_pod3, "Authentication Service", "Go", "replica 3/3")
        Container(centrifugo_pod3, "Centrifugo", "Go", "replica 3/3")
        Container(account_service_pod3, "Account Service", "Go", "replica 3/3")
        Container(user_service_pod3, "User Service", "Go", "replica 3/3")
        Container(car_service_pod3, "Car Service", "Go", "replica 3/3")
        Container(routing_service_pod3, "Routing Service", "Go", "replica 3/3")
        Container(scheduling_service_pod3, "Scheduling Service", "Go", "replica 3/3")
        Container(notifications_service_pod3, "Notifications Service", "Go", "replica 3/3")
        Container(maintenance_service_pod3, "Maintenance Service", "Go", "replica 3/3")
        Container(reports_service_pod3, "Reports Service", "Go", "replica 3/3")
    }

    Deployment_Node(stateful_node_4, "Stateful Node 4") {
        Container(rabbitmq_node1, "RabbitMQ Node 1", "RabbitMQ", "cluster node 1/3")
        Container(rabbitmq_node2, "RabbitMQ Node 2", "RabbitMQ", "cluster node 2/3")
        Container(rabbitmq_node3, "RabbitMQ Node 3", "RabbitMQ", "cluster node 3/3")
    }

    Deployment_Node(stateful_node_5, "Stateful Node 5") {
        Container(redis_master1, "Redis Master 1", "Redis", "primary node")
        Container(redis_slave1, "Redis Slave 1..n", "Redis", "replica node")
        Container(redis_sentinel, "Redis Sentinel", "Redis", "мониторинг и failover")
    }
}

Deployment_Node(db_datacenter, "Database Datacenter") {
    Deployment_Node(postgres_cluster, "PostgreSQL Cluster") {
        ContainerDb(postgres_master, "PostgreSQL Master", "PostgreSQL", "Основная БД для записи")

        Deployment_Node(db_node_2, "Database Node 2", "Физический сервер") {
            ContainerDb(postgres_slave1, "PostgreSQL Slave 1", "PostgreSQL", "Реплика для чтения")
        }
    }
}

Deployment_Node(monitoring_namespace, "Monitoring Namespace") {
    Container(prometheus, "Prometheus", "Prometheus", "Сбор метрик и мониторинг")
    Container(grafana, "Grafana", "Grafana", "Визуализация метрик и дашборды")
    Container(kibana, "Kibana", "Kibana", "Анализ логов")
}

Rel(spa_client, dns, "DNS Resolution", "DNS")
Rel(spa_client, envoy_gateway, "API запросы", "HTTPS/WebSocket")

Rel(spa_client, external_gps, "GPS данные", "HTTPS")

Rel(envoy_gateway, auth_service_pod1, "gRPC", "Маршрутизация")
Rel(envoy_gateway, account_service_pod1, "gRPC", "Маршрутизация")
Rel(envoy_gateway, user_service_pod1, "gRPC", "Маршрутизация")
Rel(envoy_gateway, car_service_pod1, "gRPC", "Маршрутизация")
Rel(envoy_gateway, routing_service_pod1, "gRPC", "Маршрутизация")
Rel(envoy_gateway, scheduling_service_pod1, "gRPC", "Маршрутизация")
Rel(envoy_gateway, notifications_service_pod1, "gRPC", "Маршрутизация")
Rel(envoy_gateway, maintenance_service_pod1, "gRPC", "Маршрутизация")
Rel(envoy_gateway, reports_service_pod1, "gRPC", "Маршрутизация")
Rel(envoy_gateway, centrifugo_pod1, "WebSocket", "Проксирование")

Rel(scheduling_service_pod1, user_service_pod1, "Получение данных пользователей", "gRPC")
Rel(scheduling_service_pod1, routing_service_pod1, "Получение маршрутов", "gRPC")
Rel(routing_service_pod1, car_service_pod1, "Получение данных транспорта", "gRPC")
Rel(notifications_service_pod1, user_service_pod1, "Получение пользовательских настроек", "gRPC")

Rel(user_service_pod1, rabbitmq_node1, "События пользователей", "AMQP")
Rel(car_service_pod1, rabbitmq_node1, "События автомобилей", "AMQP")
Rel(routing_service_pod1, rabbitmq_node2, "События маршрутов", "AMQP")
Rel(scheduling_service_pod1, rabbitmq_node2, "События расписаний", "AMQP")
Rel(maintenance_service_pod1, rabbitmq_node3, "События ТО", "AMQP")

Rel(rabbitmq_node1, notifications_service_pod1, "Уведомления", "AMQP")
Rel(rabbitmq_node2, scheduling_service_pod1, "Обновления маршрутов", "AMQP")
Rel(rabbitmq_node3, reports_service_pod1, "Обновления данных", "AMQP")

Rel(auth_service_pod1, redis_master1, "Сессии пользователей", "RESP")
Rel(user_service_pod1, redis_master1, "Кеш профилей", "RESP")
Rel(car_service_pod1, redis_master1, "Кеш автомобилей", "RESP")
Rel(routing_service_pod1, redis_master1, "Кеш маршрутов", "RESP")
Rel(reports_service_pod1, redis_master1, "Кеш отчетов", "RESP")
Rel(centrifugo_pod1, redis_master1, "Состояние WebSocket", "RESP")

Rel(redis_sentinel, redis_master1, "Мониторинг", "RESP")
Rel(redis_sentinel, redis_slave1, "Мониторинг", "RESP")

Rel(account_service_pod1, postgres_master, "Запись конфигураций", "PostgreSQL")
Rel(user_service_pod1, postgres_master, "Запись пользователей", "PostgreSQL")
Rel(car_service_pod1, postgres_master, "Запись автомобилей", "PostgreSQL")
Rel(routing_service_pod1, postgres_master, "Запись маршрутов", "PostgreSQL")
Rel(scheduling_service_pod1, postgres_master, "Запись расписаний", "PostgreSQL")
Rel(notifications_service_pod1, postgres_master, "Запись уведомлений", "PostgreSQL")
Rel(maintenance_service_pod1, postgres_master, "Запись ТО", "PostgreSQL")

Rel(reports_service_pod1, postgres_slave1, "Чтение для отчетов", "PostgreSQL")

Rel(prometheus, worker_node_1, "Сбор метрик", "HTTP")
Rel(prometheus, worker_node_2, "Сбор метрик", "HTTP")
Rel(prometheus, gateway_layer, "Сбор метрик", "HTTP")
Rel(prometheus, stateful_node_4, "Сбор метрик", "HTTP")
Rel(prometheus, stateful_node_5, "Сбор метрик", "HTTP")
Rel(prometheus, db_datacenter, "Сбор метрик", "HTTP")

Rel(grafana, prometheus, "Данные для визуализации", "HTTP")

Rel(user_service_pod1, gibdd_api, "Проверка водительских прав", "HTTPS")
Rel(car_service_pod1, gibdd_api, "Проверка VIN", "HTTPS")

Rel(rabbitmq_node1, rabbitmq_node2, "Erlang Distribution", "RabbitMQ cluster")
Rel(rabbitmq_node2, rabbitmq_node3, "Erlang Distribution", "RabbitMQ cluster")
Rel(redis_master1, redis_slave1, "Асинхронная репликация", "Redis replication")
Rel(postgres_master, postgres_slave1, "Синхронная репликация", "PostgreSQL streaming replication")

@enduml